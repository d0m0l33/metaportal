"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/extends"),t=require("react"),r=require("three"),a=require("@react-three/fiber"),n=require("react-merge-refs"),o=require("../materials/MeshReflectorMaterial.cjs.js");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function s(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var a=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,a.get?a:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var l=i(e),u=s(t),d=i(n);a.extend({MeshReflectorMaterial:o.MeshReflectorMaterial});const c=u.forwardRef((({mixBlur:e=0,mixStrength:t=.5,resolution:n=256,args:o=[1,1],minDepthThreshold:i=.9,maxDepthThreshold:s=1,depthScale:c=0,depthToBlurRatioBias:p=.25,mirror:m,children:h,debug:f=0,distortion:x=1,distortionMap:M,...g},b)=>{const w=a.useThree((({gl:e})=>e)),T=a.useThree((({camera:e})=>e)),y=a.useThree((({scene:e})=>e)),S=u.useRef(null),[R]=u.useState((()=>new r.Plane)),[F]=u.useState((()=>new r.Vector3)),[j]=u.useState((()=>new r.Vector3)),[v]=u.useState((()=>new r.Vector3)),[D]=u.useState((()=>new r.Matrix4)),[V]=u.useState((()=>new r.Vector3(0,0,-1))),[W]=u.useState((()=>new r.Vector4)),[_]=u.useState((()=>new r.Vector3)),[B]=u.useState((()=>new r.Vector3)),[E]=u.useState((()=>new r.Vector4)),[O]=u.useState((()=>new r.Matrix4)),[P]=u.useState((()=>new r.PerspectiveCamera)),[q]=u.useState((()=>{const e=[],t={minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBFormat,encoding:w.outputEncoding};for(let a=0;a<8;a++){const o=Math.max(8,Math.round(n/Math.pow(2,a))),i=new r.WebGLRenderTarget(o,o,t);i.texture.generateMipmaps=!1,e.push(i)}return e})),L=u.useCallback((()=>{if(j.setFromMatrixPosition(S.current.matrixWorld),v.setFromMatrixPosition(T.matrixWorld),D.extractRotation(S.current.matrixWorld),F.set(0,0,1),F.applyMatrix4(D),_.subVectors(j,v),_.dot(F)>0)return;_.reflect(F).negate(),_.add(j),D.extractRotation(T.matrixWorld),V.set(0,0,-1),V.applyMatrix4(D),V.add(v),B.subVectors(j,V),B.reflect(F).negate(),B.add(j),P.position.copy(_),P.up.set(0,1,0),P.up.applyMatrix4(D),P.up.reflect(F),P.lookAt(B),P.far=T.far,P.updateMatrixWorld(),P.projectionMatrix.copy(T.projectionMatrix),O.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),O.multiply(P.projectionMatrix),O.multiply(P.matrixWorldInverse),O.multiply(S.current.matrixWorld),R.setFromNormalAndCoplanarPoint(F,j),R.applyMatrix4(P.matrixWorldInverse),W.set(R.normal.x,R.normal.y,R.normal.z,R.constant);const e=P.projectionMatrix;E.x=(Math.sign(W.x)+e.elements[8])/e.elements[0],E.y=(Math.sign(W.y)+e.elements[9])/e.elements[5],E.z=-1,E.w=(1+e.elements[10])/e.elements[14],W.multiplyScalar(2/W.dot(E)),e.elements[2]=W.x,e.elements[6]=W.y,e.elements[10]=W.z+1,e.elements[14]=W.w}),[T.far,T.matrixWorld,T.projectionMatrix,v,W,V,F,E,R,j,D,B,O,_,P]),[U,k]=u.useMemo((()=>{const a={minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBFormat,encoding:w.outputEncoding},o=new r.WebGLRenderTarget(n,n,a);c>0&&(o.depthBuffer=!0,o.depthTexture=new r.DepthTexture(n,n),o.depthTexture.format=r.DepthFormat,o.depthTexture.type=r.UnsignedShortType);const l=q.reduce(((e,t,a)=>(e[`u_mipmap_${a}`]=t.texture,e[`u_mipmap_res_${a}`]=new r.Vector2(t.width,t.height),e)),{});return[o,{mirror:m,textureMatrix:O,mixBlur:e,tDiffuse:o.texture,tDepth:o.depthTexture,mixStrength:t,minDepthThreshold:i,maxDepthThreshold:s,depthScale:c,depthToBlurRatioBias:p,debug:f,distortion:x,distortionMap:M,"defines-USE_DEPTH":c>0?"":void 0,"defines-USE_DISTORTION":M?"":void 0,...l}]}),[w,O,n,m,e,t,i,s,c,p,f,x,M,q]);return a.useFrame((()=>{if(null==S||!S.current)return;S.current.visible=!1;const t=w.xr.enabled,r=w.shadowMap.autoUpdate;L(),w.xr.enabled=!1,w.shadowMap.autoUpdate=!1,w.setRenderTarget(U),w.state.buffers.depth.setMask(!0),w.autoClear||w.clear(),w.render(y,P),0!==e&&q.forEach((e=>{w.setRenderTarget(e),w.state.buffers.depth.setMask(!0),w.render(y,P)})),w.xr.enabled=t,w.shadowMap.autoUpdate=r,S.current.visible=!0,w.setRenderTarget(null)})),u.createElement("mesh",l.default({ref:d.default([S,b])},g),u.createElement("planeBufferGeometry",{args:o}),h?h("meshReflectorMaterial",k):u.createElement("meshReflectorMaterial",k))}));exports.Reflector=c;
