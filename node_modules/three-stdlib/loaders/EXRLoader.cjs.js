"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),r=require("fflate");class n extends e.DataTextureLoader{constructor(r){super(r),this.type=e.FloatType}parse(n){const a=65536,t=14,i=65537,o=16384,l=Math.pow(2.7182818,2.2);var s=new DataView(new ArrayBuffer(8));function f(e){if(0===e)return[e,0];s.setFloat64(0,e);var r=s.getUint32(0)>>>20&2047;0===r&&(s.setFloat64(0,e*Math.pow(2,64)),r=(s.getUint32(0)>>>20&2047)-64);var n=r-1022;return[function(e,r){for(var n=Math.min(3,Math.ceil(Math.abs(r)/1023)),a=e,t=0;t<n;t++)a*=Math.pow(2,Math.floor((r+t)/n));return a}(e,-n),n]}const u={l:0,c:0,lc:0};function c(e,r,n,a,t){for(;n<e;)r=r<<8|V(a,t),n+=8;n-=e,u.l=r>>n&(1<<e)-1,u.c=r,u.lc=n}const v=new Array(59);function h(e,r,n,a,t,o,l){for(var s=n,f=0,h=0;t<=o;t++){if(s.value-n.value>a)return!1;c(6,f,h,e,s);var w=u.l;if(f=u.c,h=u.lc,l[t]=w,63==w){if(s.value-n.value>a)throw"Something wrong with hufUnpackEncTable";c(8,f,h,e,s);var p=u.l+6;if(f=u.c,h=u.lc,t+p>o+1)throw"Something wrong with hufUnpackEncTable";for(;p--;)l[t++]=0;t--}else if(w>=59){if(t+(p=w-59+2)>o+1)throw"Something wrong with hufUnpackEncTable";for(;p--;)l[t++]=0;t--}}!function(e){for(var r=0;r<=58;++r)v[r]=0;for(r=0;r<i;++r)v[e[r]]+=1;var n=0;for(r=58;r>0;--r){var a=n+v[r]>>1;v[r]=n,n=a}for(r=0;r<i;++r){var t=e[r];t>0&&(e[r]=t|v[t]++<<6)}}(l)}function w(e){return 63&e}function p(e){return e>>6}const y={c:0,lc:0};function d(e,r,n,a){e=e<<8|V(n,a),r+=8,y.c=e,y.lc=r}const g={c:0,lc:0};function S(e,r,n,a,t,i,o,l,s,f){if(e==r){a<8&&(d(n,a,t,o),n=y.c,a=y.lc);var u=n>>(a-=8);u=new Uint8Array([u])[0];if(s.value+u>f)return!1;for(var c=l[s.value-1];u-- >0;)l[s.value++]=c}else{if(!(s.value<f))return!1;l[s.value++]=e}g.c=n,g.lc=a}function b(e){return 65535&e}function A(e){var r=b(e);return r>32767?r-65536:r}const U={a:0,b:0};function m(e,r){var n=A(e),a=A(r),t=n+(1&a)+(a>>1),i=t,o=t-a;U.a=i,U.b=o}function M(e,r){var n=b(e),a=b(r),t=n-(a>>1)&65535,i=a+t-32768&65535;U.a=i,U.b=t}function O(e,r,n,a,t,i,o){for(var l,s=o<16384,f=n>t?t:n,u=1;u<=f;)u<<=1;for(l=u>>=1,u>>=1;u>=1;){for(var c,v,h,w,p=0,y=p+i*(t-l),d=i*u,g=i*l,S=a*u,b=a*l;p<=y;p+=g){for(var A=p,O=p+a*(n-l);A<=O;A+=b){var E=A+S,C=(I=A+d)+S;s?(m(e[A+r],e[I+r]),c=U.a,h=U.b,m(e[E+r],e[C+r]),v=U.a,w=U.b,m(c,v),e[A+r]=U.a,e[E+r]=U.b,m(h,w),e[I+r]=U.a,e[C+r]=U.b):(M(e[A+r],e[I+r]),c=U.a,h=U.b,M(e[E+r],e[C+r]),v=U.a,w=U.b,M(c,v),e[A+r]=U.a,e[E+r]=U.b,M(h,w),e[I+r]=U.a,e[C+r]=U.b)}if(n&u){var I=A+d;s?m(e[A+r],e[I+r]):M(e[A+r],e[I+r]),c=U.a,e[I+r]=U.b,e[A+r]=c}}if(t&u)for(A=p,O=p+a*(n-l);A<=O;A+=b){E=A+S;s?m(e[A+r],e[E+r]):M(e[A+r],e[E+r]),c=U.a,e[E+r]=U.b,e[A+r]=c}l=u,u>>=1}return p}function E(e,r,n,a,l,s){var f=n.value,u=X(r,n),c=X(r,n);n.value+=4;var v=X(r,n);if(n.value+=4,u<0||u>=i||c<0||c>=i)throw"Something wrong with HUF_ENCSIZE";var b=new Array(i),A=new Array(o);if(function(e){for(var r=0;r<o;r++)e[r]={},e[r].len=0,e[r].lit=0,e[r].p=null}(A),h(e,0,n,a-(n.value-f),u,c,b),v>8*(a-(n.value-f)))throw"Something wrong with hufUncompress";!function(e,r,n,a){for(;r<=n;r++){var i=p(e[r]),o=w(e[r]);if(i>>o)throw"Invalid table entry";if(o>t){if((u=a[i>>o-t]).len)throw"Invalid table entry";if(u.lit++,u.p){var l=u.p;u.p=new Array(u.lit);for(var s=0;s<u.lit-1;++s)u.p[s]=l[s]}else u.p=new Array(1);u.p[u.lit-1]=r}else if(o){var f=0;for(s=1<<t-o;s>0;s--){var u;if((u=a[(i<<t-o)+f]).len||u.p)throw"Invalid table entry";u.len=o,u.lit=r,f++}}}}(b,u,c,A),function(e,r,n,a,i,o,l,s,f,u){for(var c=0,v=0,h=s,b=Math.trunc(i.value+(o+7)/8);i.value<b;)for(d(c,v,n,i),c=y.c,v=y.lc;v>=t;)if((M=r[c>>v-t&16383]).len)v-=M.len,S(M.lit,l,c,v,n,0,i,f,u,h),c=g.c,v=g.lc;else{if(!M.p)throw"hufDecode issues";var A;for(A=0;A<M.lit;A++){for(var U=w(e[M.p[A]]);v<U&&i.value<b;)d(c,v,n,i),c=y.c,v=y.lc;if(v>=U&&p(e[M.p[A]])==(c>>v-U&(1<<U)-1)){v-=U,S(M.p[A],l,c,v,n,0,i,f,u,h),c=g.c,v=g.lc;break}}if(A==M.lit)throw"hufDecode issues"}var m=8-o&7;for(c>>=m,v-=m;v>0;){var M;if(!(M=r[c<<t-v&16383]).len)throw"hufDecode issues";v-=M.len,S(M.lit,l,c,v,n,0,i,f,u,h),c=g.c,v=g.lc}}(b,A,e,0,n,v,c,s,l,{value:0})}function C(e){for(var r=1;r<e.length;r++){var n=e[r-1]+e[r]-128;e[r]=n}}function I(e,r){for(var n=0,a=Math.floor((e.length+1)/2),t=0,i=e.length-1;!(t>i||(r[t++]=e[n++],t>i));)r[t++]=e[a++]}function R(e){for(var r=e.byteLength,n=new Array,a=0,t=new DataView(e);r>0;){var i=t.getInt8(a++);if(i<0){r-=(l=-i)+1;for(var o=0;o<l;o++)n.push(t.getUint8(a++))}else{var l=i;r-=2;var s=t.getUint8(a++);for(o=0;o<l+1;o++)n.push(s)}}return n}function x(e,r,n){for(var a,t=1;t<64;)65280==(a=r[e.value])?t=64:a>>8==255?t+=255&a:(n[t]=a,t++),e.value++}function z(e,r){r[0]=Y(e[0]),r[1]=Y(e[1]),r[2]=Y(e[5]),r[3]=Y(e[6]),r[4]=Y(e[14]),r[5]=Y(e[15]),r[6]=Y(e[27]),r[7]=Y(e[28]),r[8]=Y(e[2]),r[9]=Y(e[4]),r[10]=Y(e[7]),r[11]=Y(e[13]),r[12]=Y(e[16]),r[13]=Y(e[26]),r[14]=Y(e[29]),r[15]=Y(e[42]),r[16]=Y(e[3]),r[17]=Y(e[8]),r[18]=Y(e[12]),r[19]=Y(e[17]),r[20]=Y(e[25]),r[21]=Y(e[30]),r[22]=Y(e[41]),r[23]=Y(e[43]),r[24]=Y(e[9]),r[25]=Y(e[11]),r[26]=Y(e[18]),r[27]=Y(e[24]),r[28]=Y(e[31]),r[29]=Y(e[40]),r[30]=Y(e[44]),r[31]=Y(e[53]),r[32]=Y(e[10]),r[33]=Y(e[19]),r[34]=Y(e[23]),r[35]=Y(e[32]),r[36]=Y(e[39]),r[37]=Y(e[45]),r[38]=Y(e[52]),r[39]=Y(e[54]),r[40]=Y(e[20]),r[41]=Y(e[22]),r[42]=Y(e[33]),r[43]=Y(e[38]),r[44]=Y(e[46]),r[45]=Y(e[51]),r[46]=Y(e[55]),r[47]=Y(e[60]),r[48]=Y(e[21]),r[49]=Y(e[34]),r[50]=Y(e[37]),r[51]=Y(e[47]),r[52]=Y(e[50]),r[53]=Y(e[56]),r[54]=Y(e[59]),r[55]=Y(e[61]),r[56]=Y(e[35]),r[57]=Y(e[36]),r[58]=Y(e[48]),r[59]=Y(e[49]),r[60]=Y(e[57]),r[61]=Y(e[58]),r[62]=Y(e[62]),r[63]=Y(e[63])}function P(e){const r=.5*Math.cos(.7853975),n=.5*Math.cos(3.14159/16),a=.5*Math.cos(3.14159/8),t=.5*Math.cos(3*3.14159/16),i=.5*Math.cos(.981746875),o=.5*Math.cos(3*3.14159/8),l=.5*Math.cos(1.374445625);for(var s=new Array(4),f=new Array(4),u=new Array(4),c=new Array(4),v=0;v<8;++v){var h=8*v;s[0]=a*e[h+2],s[1]=o*e[h+2],s[2]=a*e[h+6],s[3]=o*e[h+6],f[0]=n*e[h+1]+t*e[h+3]+i*e[h+5]+l*e[h+7],f[1]=t*e[h+1]-l*e[h+3]-n*e[h+5]-i*e[h+7],f[2]=i*e[h+1]-n*e[h+3]+l*e[h+5]+t*e[h+7],f[3]=l*e[h+1]-i*e[h+3]+t*e[h+5]-n*e[h+7],u[0]=r*(e[h+0]+e[h+4]),u[3]=r*(e[h+0]-e[h+4]),u[1]=s[0]+s[3],u[2]=s[1]-s[2],c[0]=u[0]+u[1],c[1]=u[3]+u[2],c[2]=u[3]-u[2],c[3]=u[0]-u[1],e[h+0]=c[0]+f[0],e[h+1]=c[1]+f[1],e[h+2]=c[2]+f[2],e[h+3]=c[3]+f[3],e[h+4]=c[3]-f[3],e[h+5]=c[2]-f[2],e[h+6]=c[1]-f[1],e[h+7]=c[0]-f[0]}for(var w=0;w<8;++w)s[0]=a*e[16+w],s[1]=o*e[16+w],s[2]=a*e[48+w],s[3]=o*e[48+w],f[0]=n*e[8+w]+t*e[24+w]+i*e[40+w]+l*e[56+w],f[1]=t*e[8+w]-l*e[24+w]-n*e[40+w]-i*e[56+w],f[2]=i*e[8+w]-n*e[24+w]+l*e[40+w]+t*e[56+w],f[3]=l*e[8+w]-i*e[24+w]+t*e[40+w]-n*e[56+w],u[0]=r*(e[w]+e[32+w]),u[3]=r*(e[w]-e[32+w]),u[1]=s[0]+s[3],u[2]=s[1]-s[2],c[0]=u[0]+u[1],c[1]=u[3]+u[2],c[2]=u[3]-u[2],c[3]=u[0]-u[1],e[0+w]=c[0]+f[0],e[8+w]=c[1]+f[1],e[16+w]=c[2]+f[2],e[24+w]=c[3]+f[3],e[32+w]=c[3]-f[3],e[40+w]=c[2]-f[2],e[48+w]=c[1]-f[1],e[56+w]=c[0]-f[0]}function N(e){for(var r=0;r<64;++r){var n=e[0][r],a=e[1][r],t=e[2][r];e[0][r]=n+1.5747*t,e[1][r]=n-.1873*a-.4682*t,e[2][r]=n+1.8556*a}}function F(r,n,a){for(var t=0;t<64;++t)n[a+t]=e.DataUtils.toHalfFloat(T(r[t]))}function T(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(l,Math.abs(e)-1)}function k(e){var n=e.array.slice(e.offset.value,e.offset.value+e.size),a=r.unzlibSync(n),t=new Uint8Array(a.length);return C(a),I(a,t),new DataView(t.buffer)}function D(e){var n=e.viewer,a={value:e.offset.value},t=new Uint8Array(e.width*e.lines*(J.channels.length*e.type*2)),i={version:Z(n,a),unknownUncompressedSize:Z(n,a),unknownCompressedSize:Z(n,a),acCompressedSize:Z(n,a),dcCompressedSize:Z(n,a),rleCompressedSize:Z(n,a),rleUncompressedSize:Z(n,a),rleRawSize:Z(n,a),totalAcUncompressedCount:Z(n,a),totalDcUncompressedCount:Z(n,a),acCompression:Z(n,a)};if(i.version<2)throw"EXRLoader.parse: "+J.compression+" version "+i.version+" is unsupported";for(var o=new Array,l=G(n,a)-2;l>0;){var s=_(n.buffer,a),f=W(n,a),u=f>>2&3,c=new Int8Array([(f>>4)-1])[0],v=W(n,a);o.push({name:s,index:c,type:v,compression:u}),l-=s.length+3}for(var h=J.channels,w=new Array(e.channels),p=0;p<e.channels;++p){var y=w[p]={},d=h[p];y.name=d.name,y.compression=0,y.decoded=!1,y.type=d.pixelType,y.pLinear=d.pLinear,y.width=e.width,y.height=e.lines}for(var g={idx:new Array(3)},S=0;S<e.channels;++S)for(y=w[S],p=0;p<o.length;++p){var b=o[p];y.name==b.name&&(y.compression=b.compression,b.index>=0&&(g.idx[b.index]=S),y.offset=S)}if(i.acCompressedSize>0)switch(i.acCompression){case 0:var A=new Uint16Array(i.totalAcUncompressedCount);E(e.array,n,a,i.acCompressedSize,A,i.totalAcUncompressedCount);break;case 1:var U=e.array.slice(a.value,a.value+i.totalAcUncompressedCount),m=r.unzlibSync(U);A=new Uint16Array(m.buffer);a.value+=i.totalAcUncompressedCount}if(i.dcCompressedSize>0){var M={array:e.array,offset:a,size:i.dcCompressedSize},O=new Uint16Array(k(M).buffer);a.value+=i.dcCompressedSize}if(i.rleRawSize>0){U=e.array.slice(a.value,a.value+i.rleCompressedSize);var C=R((m=r.unzlibSync(U)).buffer);a.value+=i.rleCompressedSize}var I=0,T=new Array(w.length);for(p=0;p<T.length;++p)T[p]=new Array;for(var D=0;D<e.lines;++D)for(var L=0;L<w.length;++L)T[L].push(I),I+=w[L].width*e.type*2;!function(e,r,n,a,t,i){var o=new DataView(i.buffer),l=n[e.idx[0]].width,s=n[e.idx[0]].height,f=Math.floor(l/8),u=Math.ceil(l/8),c=Math.ceil(s/8),v=l-8*(u-1),h=s-8*(c-1),w={value:0},p=new Array(3),y=new Array(3),d=new Array(3),g=new Array(3),S=new Array(3);for(let n=0;n<3;++n)S[n]=r[e.idx[n]],p[n]=n<1?0:p[n-1]+u*c,y[n]=new Float32Array(64),d[n]=new Uint16Array(64),g[n]=new Uint16Array(64*u);for(let r=0;r<c;++r){var b=8;r==c-1&&(b=h);var A=8;for(let e=0;e<u;++e){e==u-1&&(A=v);for(let e=0;e<3;++e)d[e].fill(0),d[e][0]=t[p[e]++],x(w,a,d[e]),z(d[e],y[e]),P(y[e]);N(y);for(let r=0;r<3;++r)F(y[r],g[r],64*e)}let i=0;for(let a=0;a<3;++a){const t=n[e.idx[a]].type;for(let e=8*r;e<8*r+b;++e){i=S[a][e];for(let r=0;r<f;++r){const n=64*r+8*(7&e);o.setUint16(i+0*t,g[a][n+0],!0),o.setUint16(i+2*t,g[a][n+1],!0),o.setUint16(i+4*t,g[a][n+2],!0),o.setUint16(i+6*t,g[a][n+3],!0),o.setUint16(i+8*t,g[a][n+4],!0),o.setUint16(i+10*t,g[a][n+5],!0),o.setUint16(i+12*t,g[a][n+6],!0),o.setUint16(i+14*t,g[a][n+7],!0),i+=16*t}}if(f!=u)for(let e=8*r;e<8*r+b;++e){const r=S[a][e]+8*f*2*t,n=64*f+8*(7&e);for(let e=0;e<A;++e)o.setUint16(r+2*e*t,g[a][n+e],!0)}}}for(var U=new Uint16Array(l),m=(o=new DataView(i.buffer),0);m<3;++m){n[e.idx[m]].decoded=!0;var M=n[e.idx[m]].type;if(2==n[m].type)for(var O=0;O<s;++O){const e=S[m][O];for(var E=0;E<l;++E)U[E]=o.getUint16(e+2*E*M,!0);for(E=0;E<l;++E)o.setFloat32(e+2*E*M,Y(U[E]),!0)}}}(g,T,w,A,O,t);for(p=0;p<w.length;++p){if(!(y=w[p]).decoded)switch(y.compression){case 2:var B=0,X=0;for(D=0;D<e.lines;++D){for(var V=T[p][B],H=0;H<y.width;++H){for(var q=0;q<2*y.type;++q)t[V++]=C[X+q*y.width*y.height];X++}B++}break;case 1:default:throw"EXRLoader.parse: unsupported channel compression"}}return new DataView(t.buffer)}function _(e,r){for(var n=new Uint8Array(e),a=0;0!=n[r.value+a];)a+=1;var t=(new TextDecoder).decode(n.slice(r.value,r.value+a));return r.value=r.value+a+1,t}function L(e,r){var n=e.getUint32(0,!0);return r.value=r.value+8,n}function B(e,r){var n=e.getInt32(r.value,!0);return r.value=r.value+4,n}function X(e,r){var n=e.getUint32(r.value,!0);return r.value=r.value+4,n}function V(e,r){var n=e[r.value];return r.value=r.value+1,n}function W(e,r){var n=e.getUint8(r.value);return r.value=r.value+1,n}function Z(e,r){var n=Number(e.getBigInt64(r.value,!0));return r.value+=8,n}function H(e,r){var n=e.getFloat32(r.value,!0);return r.value+=4,n}function Y(e){var r=(31744&e)>>10,n=1023&e;return(e>>15?-1:1)*(r?31===r?n?NaN:1/0:Math.pow(2,r-15)*(1+n/1024):n/1024*6103515625e-14)}function G(e,r){var n=e.getUint16(r.value,!0);return r.value+=2,n}function q(e,r,n,a,t){return"string"===a||"stringvector"===a||"iccProfile"===a?function(e,r,n){var a=(new TextDecoder).decode(new Uint8Array(e).slice(r.value,r.value+n));return r.value=r.value+n,a}(r,n,t):"chlist"===a?function(e,r,n,a){for(var t=n.value,i=[];n.value<t+a-1;){var o=_(r,n),l=B(e,n),s=W(e,n);n.value+=3;var f=B(e,n),u=B(e,n);i.push({name:o,pixelType:l,pLinear:s,xSampling:f,ySampling:u})}return n.value+=1,i}(e,r,n,t):"chromaticities"===a?function(e,r){return{redX:H(e,r),redY:H(e,r),greenX:H(e,r),greenY:H(e,r),blueX:H(e,r),blueY:H(e,r),whiteX:H(e,r),whiteY:H(e,r)}}(e,n):"compression"===a?function(e,r){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][W(e,r)]}(e,n):"box2i"===a?function(e,r){return{xMin:X(e,r),yMin:X(e,r),xMax:X(e,r),yMax:X(e,r)}}(e,n):"lineOrder"===a?function(e,r){return["INCREASING_Y"][W(e,r)]}(e,n):"float"===a?H(e,n):"v2f"===a?function(e,r){return[H(e,r),H(e,r)]}(e,n):"v3f"===a?function(e,r){return[H(e,r),H(e,r),H(e,r)]}(e,n):"int"===a?B(e,n):"rational"===a?function(e,r){return[B(e,r),X(e,r)]}(e,n):"timecode"===a?function(e,r){return[X(e,r),X(e,r)]}(e,n):"preview"===a?(n.value+=t,"skipped"):void(n.value+=t)}var j=new DataView(n),$=new Uint8Array(n),J={};j.getUint32(0,!0),j.getUint8(4,!0),j.getUint8(5,!0);for(var K={value:8},Q=!0;Q;){var ee=_(n,K);if(0==ee)Q=!1;else{var re=_(n,K),ne=q(j,n,K,re,X(j,K));void 0===ne?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${re}'.`):J[ee]=ne}}var ae,te,ie,oe,le=J.dataWindow.yMax+1;switch(J.compression){case"NO_COMPRESSION":te=1,ae=function(e){return new DataView(e.array.buffer,e.offset.value,e.size)};break;case"RLE_COMPRESSION":te=1,ae=function(e){var r=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),n=new Uint8Array(R(r)),a=new Uint8Array(n.length);return C(n),I(n,a),new DataView(a.buffer)};break;case"ZIPS_COMPRESSION":te=1,ae=k;break;case"ZIP_COMPRESSION":te=16,ae=k;break;case"PIZ_COMPRESSION":te=32,ae=function(e){for(var r=e.viewer,n={value:e.offset.value},t=e.width*te*(J.channels.length*e.type),i=new Uint16Array(t),o=new Uint8Array(8192),l=0,s=new Array(e.channels),f=0;f<e.channels;f++)s[f]={},s[f].start=l,s[f].end=s[f].start,s[f].nx=e.width,s[f].ny=e.lines,s[f].size=e.type,l+=s[f].nx*s[f].ny*s[f].size;var u=G(r,n),c=G(r,n);if(c>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(u<=c)for(f=0;f<c-u+1;f++)o[f+u]=W(r,n);var v=new Uint16Array(a),h=function(e,r){for(var n=0,t=0;t<a;++t)(0==t||e[t>>3]&1<<(7&t))&&(r[n++]=t);for(var i=n-1;n<a;)r[n++]=0;return i}(o,v),w=X(r,n);for(E(e.array,r,n,w,i,l),f=0;f<e.channels;++f)for(var p=s[f],y=0;y<s[f].size;++y)O(i,p.start+y,p.nx,p.size,p.ny,p.nx*p.size,h);!function(e,r,n){for(var a=0;a<n;++a)r[a]=e[r[a]]}(v,i,l);for(var d=0,g=new Uint8Array(i.buffer.byteLength),S=0;S<e.lines;S++)for(var b=0;b<e.channels;b++){var A=(p=s[b]).nx*p.size,U=new Uint8Array(i.buffer,2*p.end,2*A);g.set(U,d),d+=2*A,p.end+=A}return new DataView(g.buffer)};break;case"PXR24_COMPRESSION":te=16,ae=function(e){var n=e.array.slice(e.offset.value,e.offset.value+e.size),a=r.unzlibSync(n);const t=e.lines*e.channels*e.width,i=1==e.type?new Uint16Array(t):new Uint32Array(t);let o=0,l=0;const s=new Array(4);for(let r=0;r<e.lines;r++)for(let r=0;r<e.channels;r++){let r=0;switch(e.type){case 1:s[0]=o,s[1]=s[0]+e.width,o=s[1]+e.width;for(let n=0;n<e.width;++n)r+=a[s[0]++]<<8|a[s[1]++],i[l]=r,l++;break;case 2:s[0]=o,s[1]=s[0]+e.width,s[2]=s[1]+e.width,o=s[2]+e.width;for(let n=0;n<e.width;++n)r+=a[s[0]++]<<24|a[s[1]++]<<16|a[s[2]++]<<8,i[l]=r,l++}}return new DataView(i.buffer)};break;case"DWAA_COMPRESSION":te=32,ae=D;break;case"DWAB_COMPRESSION":te=256,ae=D;break;default:throw"EXRLoader.parse: "+J.compression+" is unsupported"}var se=J.channels[0].pixelType;if(1===se)switch(this.type){case e.UnsignedByteType:case e.FloatType:oe=function(e,r){return Y(G(e,r))},ie=2;break;case e.HalfFloatType:oe=G,ie=2}else{if(2!==se)throw"EXRLoader.parse: unsupported pixelType "+se+" for "+J.compression+".";switch(this.type){case e.UnsignedByteType:case e.FloatType:oe=H,ie=4;break;case e.HalfFloatType:oe=function(r,n){return e.DataUtils.toHalfFloat(H(r,n))},ie=4}}for(var fe=le/te,ue=0;ue<fe;ue++)L(j,K);var ce=J.dataWindow.xMax-J.dataWindow.xMin+1,ve=J.dataWindow.yMax-J.dataWindow.yMin+1,he=ce*ve*4;switch(this.type){case e.UnsignedByteType:case e.FloatType:var we=new Float32Array(he);J.channels.length<4&&we.fill(1,0,he);break;case e.HalfFloatType:we=new Uint16Array(he);J.channels.length<4&&we.fill(15360,0,he);break;default:console.error("THREE.EXRLoader: unsupported type: ",this.type)}for(var pe,ye,de={R:0,G:1,B:2,A:3},ge={size:0,width:ce,lines:te,offset:K,array:$,viewer:j,type:se,channels:J.channels.length},Se={value:0},be=0;be<ve/te;be++){pe=X(j,K),he=X(j,K),ge.lines=pe+te>ve?ve-pe:te,ge.offset=K,ge.size=he,ye=ae(ge),K.value+=he;for(var Ae=0;Ae<te;Ae++){var Ue=Ae+be*te;if(Ue>=ve)break;for(var me=0;me<J.channels.length;me++)for(var Me=de[J.channels[me].name],Oe=0;Oe<ce;Oe++){var Ee=Ae*(J.channels.length*ce)+me*ce+Oe;Se.value=Ee*ie;var Ce=oe(ye,Se);we[4*ce*(ve-1-Ue)+4*Oe+Me]=Ce}}}if(this.type===e.UnsignedByteType){let e,r;const n=we.length,a=new Uint8Array(n);for(let n=0;n<ve;++n)for(let t=0;t<ce;++t){r=n*ce*4+4*t;const i=we[r],o=we[r+1],l=we[r+2];if(e=i>o?i:o,e=l>e?l:e,e<1e-32)a[r]=a[r+1]=a[r+2]=a[r+3]=0;else{const n=f(e);e=256*n[0]/e,a[r]=i*e,a[r+1]=o*e,a[r+2]=l*e,a[r+3]=n[1]+128}}we=a}const Ie=this.type===e.UnsignedByteType?e.RGBEFormat:e.RGBAFormat;return{header:J,width:ce,height:ve,data:we,format:Ie,type:this.type}}setDataType(e){return this.type=e,this}load(r,n,a,t){return super.load(r,(function(r,a){switch(r.type){case e.UnsignedByteType:r.encoding=e.RGBEEncoding,r.minFilter=e.NearestFilter,r.magFilter=e.NearestFilter,r.generateMipmaps=!1,r.flipY=!1;break;case e.FloatType:case e.HalfFloatType:r.encoding=e.LinearEncoding,r.minFilter=e.LinearFilter,r.magFilter=e.LinearFilter,r.generateMipmaps=!1,r.flipY=!1}n&&n(r,a)}),a,t)}}exports.EXRLoader=n;
